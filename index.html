<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>UK Carbon Intensity — Interactive Forecast</title>
  <meta name="description" content="Interactive UK carbon intensity forecast."/>
  <script src="https://cdn.plot.ly/plotly-2.30.1.min.js"></script>
  <style>
    :root{--bg:#0b1020;--card:#121a31;--text:#e8ecf4;--muted:#9fb0ca;--accent:#6aa2ff;--accent2:#7c5cff;--ring:rgba(106,162,255,.45);--radius:16px;--maxw:1200px}
    @media (prefers-color-scheme: light){
      :root{--bg:#f6f8fc;--card:#fff;--text:#171a1f;--muted:#546178;--accent:#2b6eff;--accent2:#7c5cff;--ring:rgba(43,110,255,.25)}
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:radial-gradient(1100px 700px at 10% -10%,rgba(124,92,255,.18),transparent 35%),radial-gradient(900px 600px at 100% 0%,rgba(106,162,255,.18),transparent 45%),var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial}
    .container{max-width:var(--maxw);margin:0 auto;padding:24px;display:grid;gap:18px}
    header{text-align:center}
    header h1{margin:0 0 6px;font-size:clamp(1.6rem,2vw+1rem,2.3rem)}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0));backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .panel{padding:14px 16px}
    .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:center;border-bottom:1px solid rgba(255,255,255,.08);padding:10px 14px}
    label{color:var(--muted);font-weight:600;letter-spacing:.2px}
    select{appearance:none;background:var(--card);color:var(--text);border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:10px 12px;outline:none;transition:box-shadow .2s,border-color .2s}
    select:focus{border-color:var(--accent);box-shadow:0 0 0 6px var(--ring)}
    .charts{display:grid;grid-template-columns:1fr;gap:16px}
    .chart{width:100%;min-height:360px}
    .summary{display:grid;gap:10px;justify-items:center;text-align:center}
    .kpis{display:flex;flex-wrap:wrap;gap:12px;justify-content:center}
    .kpi{min-width:220px}
    .kpi h3{margin:0 0 2px;font-size:1.7rem}
    .kpi span{color:var(--muted);font-size:.92rem}
    .badge{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:8px 10px}
    .pill{display:inline-flex;align-items:center;gap:8px;font-weight:700;letter-spacing:.2px}
    .pill-green{background:rgba(106,162,255,.18);border:1px solid var(--accent);color:var(--text);padding:6px 10px;border-radius:999px}
    .status{text-align:center;color:var(--muted);font-size:.95rem;padding:6px}
    .backdrop{position:fixed;inset:0;display:grid;place-items:center;background:rgba(10,16,32,.55);backdrop-filter:blur(3px);z-index:10;transition:opacity .25s,visibility .25s}
    .backdrop.hidden{opacity:0;visibility:hidden}
    .spinner{width:72px;height:72px;border:6px solid rgba(255,255,255,.25);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;box-shadow:0 0 0 4px rgba(0,0,0,.12) inset}
    @keyframes spin{to{transform:rotate(360deg)}}
    .sr-only{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}
    .subcontrols{display:flex;flex-direction:column;gap:8px;padding:8px 0 4px;align-items:stretch}
    .hint{font-size:.9rem}

    .compare-control{display:grid;gap:10px;width:100%}
    .compare-grid{display:grid;gap:8px;grid-template-columns:repeat(auto-fit,minmax(140px,1fr))}
    .toggle{
      display:flex;align-items:center;justify-content:center;padding:8px 10px;border-radius:12px;cursor:pointer;
      border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.04);user-select:none;transition:transform .05s,border-color .2s
    }
    .toggle:hover{border-color:var(--accent)}
    .toggle[aria-pressed="true"]{background:rgba(106,162,255,.15);border-color:var(--accent)}
    .toggle[disabled]{opacity:.5;cursor:not-allowed}
    .chips{display:flex;flex-wrap:wrap;gap:8px;min-height:28px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);font-size:.92rem
    }
    .chip button{border:none;background:transparent;color:inherit;cursor:pointer;padding:0 2px;line-height:1}
    .subcontrols select[hidden]{display:none}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>48-Hour Carbon Intensity Forecast</h1>
    </header>

    <section class="card panel" aria-labelledby="summary-title">
      <h2 id="summary-title" class="sr-only">Selected region summary</h2>
      <div class="summary" id="summary">
        <span class="pill pill-green" id="greenestLabel">Greenest 3-hour window</span>
        <div class="kpis">
          <div class="kpi">
            <h3 id="kpi-time">—</h3>
            <span>Window time</span>
          </div>
          <div class="kpi">
            <h3 id="kpi-intensity">—</h3>
            <span>Avg intensity (gCO₂/kWh)</span>
          </div>
          <div class="kpi">
            <h3 id="kpi-renew">—</h3>
            <span>Avg renewables (%)</span>
          </div>
        </div>
        <span class="badge"><strong id="kpi-region">—</strong></span>
      </div>
    </section>

    <section class="card" aria-labelledby="controls-heading">
      <div class="controls">
        <h2 id="controls-heading" class="sr-only">Controls</h2>
        <label for="region">Region</label>
        <select id="region"></select>
      </div>

      <div class="panel charts">
        <div id="intensityChart" class="chart" aria-label="Carbon intensity"></div>
        <div id="mixChart" class="chart" aria-label="Generation mix"></div>

        <div class="subcontrols">
          <label>Compare regions</label>
          <div id="compareControl" class="compare-control">
            <div id="compareChips" class="chips" aria-live="polite"></div>
            <div id="compareGrid" class="compare-grid" role="group" aria-label="Region toggles"></div>
            <div class="hint muted">
              <span id="compareCount">0</span>/5 selected ·
              <button id="clearCompare" type="button">Clear</button>
            </div>
          </div>
          <select id="compare" multiple hidden></select>
        </div>

        <div id="compareChart" class="chart" aria-label="Regional comparison"></div>
        <div class="status" id="status"></div>
      </div>
    </section>

    <section class="card panel">
      <div class="links" style="text-align:center">
        Data: UK National Grid
        <a href="https://carbon-intensity.github.io/api-definitions/?python#carbon-intensity-api-v2-0-0" target="_blank" rel="noopener">Carbon Intensity API</a> ·
        <a href="https://github.com/Ianlmgoddard/UKCarbonIntensityData.jl" target="_blank" rel="noopener">Julia wrapper</a> ·
        <a href="https://github.com/OSUKED/CIDataPortal" target="_blank" rel="noopener">Python wrapper</a> ·
        <a href="https://github.com/Ianlmgoddard/CarbonIntensitySite" target="_blank" rel="noopener">GitHub</a>
      </div>
    </section>
  </div>

  <div id="backdrop" class="backdrop" role="status" aria-live="assertive" aria-label="Loading data">
    <div class="spinner" title="Loading"></div>
  </div>

  <script>
  (function(){
    const qs = (s, el=document)=>el.querySelector(s);
    const statusEl = qs('#status');
    const regionSel = qs('#region');
    const kpiRegion = qs('#kpi-region');
    const kpiTime = qs('#kpi-time');
    const kpiInt = qs('#kpi-intensity');
    const kpiRen = qs('#kpi-renew');
    const backdrop = qs('#backdrop');

    const setCookie = (k,v,d=365)=>{const t=new Date();t.setTime(t.getTime()+d*24*60*60*1000);document.cookie=`${k}=${encodeURIComponent(v)}; expires=${t.toUTCString()}; path=/`};
    const getCookie = (k)=>{const p=`${k}=`;return document.cookie.split(';').map(c=>c.trim()).find(c=>c.startsWith(p))?.slice(p.length)||null};

    const showLoading=(on=true)=>{backdrop.classList.toggle('hidden',!on);statusEl.textContent=on?'Loading forecast…':'';statusEl.classList.remove('error')};
    const showError=(msg)=>{backdrop.classList.add('hidden');statusEl.textContent=msg;statusEl.classList.add('error')};

    const now = new Date();
    const start = new Date(now.getFullYear(),now.getMonth(),now.getDate(),now.getHours(),0,0);
    const iso = start.toISOString().split(':00.')[0]+'z';
    const API = `https://api.carbonintensity.org.uk/regional/intensity/${iso}/fw48h`;

    let times=[], regions=[], forecasts=[], mixes=[], fuels=[], regionList=[];
    let current = {times:[],forecasts:[],mixes:[],fuels:[]};
    let idxNow = 0;

    const Repeat = (arr, repeats)=>arr.map(x=>Array.from({length:repeats},()=>x)).flat();
    const isRenewable = (fuel)=>['wind','solar','hydro','biomass'].includes(String(fuel||'').toLowerCase());

    function nearestIndex(dateArr, ref){
      let best=0, bestDiff=Infinity;
      for(let i=0;i<dateArr.length;i++){
        const d=Math.abs(dateArr[i]-ref);
        if(d<bestDiff){best=i;bestDiff=d;}
      }
      return best;
    }

    async function loadAll(){
      showLoading(true);
      try{
        const curRes = await fetch(API,{cache:"no-store"});
        if(!curRes.ok) throw new Error('API error');
        const cur = await curRes.json();

        const n = cur.data[0].regions.length;
        times   = Repeat(cur.data.map(d=>new Date(d.to)), n);
        regions = cur.data.flatMap(d=>d.regions.map(r=>r.shortname));
        forecasts = cur.data.flatMap(d=>d.regions.map(r=>r.intensity.forecast));
        mixes = cur.data.flatMap(d=>d.regions.map(r=>r.generationmix.map(m=>m.perc)));
        fuels = cur.data.flatMap(d=>d.regions.map(r=>r.generationmix.map(m=>m.fuel)));

        regionList = [...new Set(regions)].sort();

        initControls();

        const steps = times.length / regionList.length;
        const blockTimes = times.slice(0, steps);
        idxNow = nearestIndex(blockTimes, start);

        const cookieRegion = getCookie('RegionCookie');
        const defRegion = cookieRegion && regionList.includes(cookieRegion) ? cookieRegion : (regionList.includes('GB') ? 'GB' : regionList[0]);
        regionSel.value = defRegion;
        sliceForRegion(defRegion);

        updateSummaryForRegion(defRegion);
        drawAll();
        showLoading(false);
      }catch(e){
        console.error(e);
        showError('Unable to load data right now.');
      }
    }

    function initControls(){
      regionSel.innerHTML = regionList.map(r=>`<option value="${r}">${r}</option>`).join('');
      buildCompareGrid();
      regionSel.addEventListener('change', ()=>{
        setCookie('RegionCookie', regionSel.value);
        sliceForRegion(regionSel.value);
        onSelectedRegionChanged();
        updateSummaryForRegion(regionSel.value);
        drawAll();
      });
    }

    function sliceForRegion(region){
      const t=[], f=[], m=[], fu=[];
      for(let i=0;i<regions.length;i++){
        if(regions[i]===region){
          t.push(times[i]); f.push(forecasts[i]); m.push(mixes[i]); fu.push(fuels[i]);
        }
      }
      current={times:t,forecasts:f,mixes:m,fuels:fu};
    }

    function findBestWindow(arr, window=3){
      if(arr.length===0) return null;
      let bestIdx=0, best=Infinity;
      for(let i=0;i<=arr.length-window;i++){
        let s=0; for(let j=0;j<window;j++) s+=arr[i+j];
        const avg=s/window;
        if(avg<best){best=avg;bestIdx=i;}
      }
      return {start:bestIdx, end:bestIdx+window-1, avg:best};
    }

    function avgRenewablesShare(startIdx, endIdx){
      const fuelsRow = current.fuels[0] || [];
      let total = 0;
      const len = Math.max(1, endIdx - startIdx + 1);
      for(let i=startIdx;i<=endIdx;i++){
        const mixRow = current.mixes[i] || [];
        let ren = 0;
        for(let k=0;k<mixRow.length;k++){
          if(isRenewable(fuelsRow[k])) ren += mixRow[k] || 0;
        }
        total += ren;
      }
      return total / len;
    }

    function formatWindowLabel(startIdx, endIdx){
      const t0 = current.times[startIdx];
      const t1 = current.times[endIdx];
      if(!t0 || !t1) return '—';
      const tf = {hour:'2-digit', minute:'2-digit'};
      const df = {weekday:'short', day:'2-digit', month:'short'};
      return `${t0.toLocaleTimeString([], tf)}–${t1.toLocaleTimeString([], tf)} · ${t0.toLocaleDateString([], df)}`;
    }

    function updateSummaryForRegion(region){
      const best = findBestWindow(current.forecasts, 3);
      if(best){
        const avgInt = best.avg;
        const avgRen = avgRenewablesShare(best.start, best.end);
        kpiTime.textContent = formatWindowLabel(best.start, best.end);
        kpiRegion.textContent = region || '—';
        kpiInt.textContent = isFinite(avgInt) ? Math.round(avgInt).toString() : '—';
        kpiRen.textContent = isFinite(avgRen) ? Math.round(avgRen).toString() : '—';
      }else{
        const i = Math.min(idxNow, current.forecasts.length-1);
        const mixRow = current.mixes[i] || [];
        const fuelsRow = current.fuels[0] || [];
        let ren=0; for(let k=0;k<mixRow.length;k++){ if(isRenewable(fuelsRow[k])) ren+=mixRow[k]||0; }
        kpiTime.textContent = current.times[i] ? current.times[i].toLocaleString() : '—';
        kpiRegion.textContent = region || '—';
        kpiInt.textContent = current.forecasts[i]!=null ? Math.round(current.forecasts[i]).toString() : '—';
        kpiRen.textContent = isFinite(ren) ? Math.round(ren).toString() : '—';
      }
    }

    function drawIntensity(){
        const best = findBestWindow(current.forecasts, 3);
        const shapes = [];
        const annotations = [];
        if(best){
            const x0 = current.times[best.start], x1 = current.times[best.end];
            shapes.push({
            type:'rect', xref:'x', yref:'paper',
            x0, x1, y0:0, y1:1,
            fillcolor:'rgba(106,162,255,.12)', line:{width:0}
            });
            annotations.push({
            x:x0, y:1.08, xref:'x', yref:'paper',
            showarrow:false,
            text:`Greener window (~${Math.round(best.avg)} gCO₂/kWh)`,
            font:{size:12}
            });
        }

        const trace = {
            x: current.times, y: current.forecasts,
            mode:'lines', type:'scatter',
            line:{width:2},
            hovertemplate:'Intensity: %{y:.0f} gCO₂/kWh<br>Time: %{x}<extra></extra>'
        };

        Plotly.newPlot('intensityChart', [trace], {
            title:{text:`Forecast CO₂ Intensity — ${regionSel.value}`, x:0.01},
            margin:{l:60,r:20,t:50,b:50},
            yaxis:{title:'gCO₂/kWh', automargin:true},
            xaxis:{title:'Time', tickformat:'%H:%M<br>%a %d %b'},
            shapes, annotations
        }, {displayModeBar:true, responsive:true});
    }


    function drawMix(){
      const fuelsAtT1 = current.fuels[0] || [];
      const traces = fuelsAtT1.map((fuelName, idx)=>({
        x: current.times, y: current.mixes.map(row=>row[idx]), name: fuelName,
        type:'scatter', mode:'lines', stackgroup:'one', groupnorm:'percent',
        hovertemplate:`<b>${fuelName}</b><br>%: %{y:.2f}<br>Time: %{x}<extra></extra>`
      }));

      Plotly.newPlot('mixChart', traces, {
        title:{text:`Generation Mix (%) — ${regionSel.value}`, x:0.01},
        margin:{l:60,r:20,t:50,b:50},
        yaxis:{title:'Percent', ticksuffix:'%', range:[0,100], automargin:true},
        xaxis:{title:'Time', tickformat:'%H:%M<br>%a %d %b'},
        legend:{orientation:'h', y:-0.2}
      }, {displayModeBar:true, responsive:true});
    }

    function drawComparison(){
      const selected = Array.from(selectedRegions);
      const traces = [];
      const fullTimes = times.filter((_, i) => i % regionList.length === 0);

      for (const r of selected) {
        const ys = [];
        for (let i = 0; i < regions.length; i++) {
          if (regions[i] === r) ys.push(forecasts[i]);
        }
        traces.push({ x: fullTimes, y: ys, name: r, type: 'scatter', mode: 'lines' });
      }

      Plotly.newPlot('compareChart', traces, {
        title:{ text:'Regional Comparison (CO₂ Intensity)', x:0.01 },
        margin:{ l:60, r:20, t:50, b:50 },
        yaxis:{ title:'gCO₂/kWh', automargin:true },
        xaxis:{ title:'Time', tickformat:'%H:%M<br>%a %d %b' },
        legend:{ orientation:'h', y:-0.2 }
      }, { displayModeBar:true, responsive:true });
    }

    const compareGrid = qs('#compareGrid');
    const compareChips = qs('#compareChips');
    const compareCount = qs('#compareCount');
    const clearCompareBtn = qs('#clearCompare');

    const selectedRegions = new Set();
    const MAX_COMPARE = 5;

    function buildCompareGrid(){
      compareGrid.innerHTML = regionList.map(r => (
        `<button type="button" class="toggle" data-region="${r}" aria-pressed="false">${r}</button>`
      )).join('');

      compareGrid.addEventListener('click', (e) => {
        const btn = e.target.closest('.toggle');
        if(!btn) return;
        const r = btn.dataset.region;
        if(r === regionSel.value) return;

        if(selectedRegions.has(r)) selectedRegions.delete(r);
        else if(selectedRegions.size < MAX_COMPARE) selectedRegions.add(r);

        syncCompareUI();
      });

      clearCompareBtn.addEventListener('click', () => {
        selectedRegions.clear();
        syncCompareUI();
      });

      syncCompareUI();
    }

    function syncCompareUI(){
      const hidden = qs('#compare');
      hidden.innerHTML = Array.from(selectedRegions).map(r => `<option value="${r}" selected></option>`).join('');

      compareChips.innerHTML = Array.from(selectedRegions).map(r => (
        `<span class="chip">${r}<button type="button" aria-label="Remove ${r}" data-remove="${r}">✕</button></span>`
      )).join('');
      compareChips.onclick = (e) => {
        const r = e.target?.dataset?.remove;
        if(!r) return;
        selectedRegions.delete(r);
        syncCompareUI();
      };

      compareCount.textContent = String(selectedRegions.size);

      const atMax = selectedRegions.size >= MAX_COMPARE;
      [...compareGrid.querySelectorAll('.toggle')].forEach(btn => {
        const r = btn.dataset.region;
        const pressed = selectedRegions.has(r);
        btn.setAttribute('aria-pressed', pressed ? 'true' : 'false');
        btn.disabled = (atMax && !pressed) || (r === regionSel.value);
      });

      drawComparison();
    }

    function onSelectedRegionChanged(){
      if(selectedRegions.has(regionSel.value)){
        selectedRegions.delete(regionSel.value);
      }
      syncCompareUI();
    }

    function drawAll(){
      updateSummaryForRegion(regionSel.value);
      drawIntensity();
      drawMix();
      drawComparison();
      statusEl.textContent = `Showing forecast for region: ${regionSel.value}`;
    }

    loadAll();
  })();
  </script>
</body>
</html>
